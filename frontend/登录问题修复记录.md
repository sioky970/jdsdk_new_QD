# 登录问题修复记录

## 问题历程

### 问题1: 404 Not Found
**错误**: `POST http://localhost:9528/proxy-default/api/auth/login 404 (Not Found)`

**原因**: 
- 前端启动使用 `test` 模式（`pnpm dev` 执行 `vite --mode test`）
- `.env.test` 文件中后端地址配置为 Apifox Mock 地址
- 请求被发送到不存在的Mock服务器

**解决方案**:
```env
# .env.test 修改前
VITE_SERVICE_BASE_URL=https://mock.apifox.cn/m1/3109515-0-default

# .env.test 修改后
VITE_SERVICE_BASE_URL=http://localhost:5001
```

**结果**: ✅ 代理工作正常，请求成功转发到后端

---

### 问题2: 401 Unauthorized
**错误**: `Failed to load resource: the server responded with a status of 401 (Unauthorized)`

**原因**:
- 前端请求拦截器中添加了 `apifoxToken` header
- 这是 Apifox 测试工具的专用 token
- Go 后端不认识这个 header，导致认证失败

**解决方案**:
```typescript
// src/service/request/index.ts 修改前
export const request = createFlatRequest(
  {
    baseURL,
    headers: {
      apifoxToken: 'XL299LiMEDZ0H5h3A29PxwQXdMJqWyY2'  // ❌ 移除
    }
  },

// src/service/request/index.ts 修改后
export const request = createFlatRequest(
  {
    baseURL
    // 移除 apifoxToken，使用真实后端API
  },
```

**结果**: ✅ 登录请求正常，后端返回200状态码

---

## 修复文件清单

1. **`.env.test`** - 修改后端服务地址
2. **`src/service/request/index.ts`** - 移除 apifoxToken header

---

## 验证步骤

### 1. 验证代理配置
检查 Vite 控制台日志：
```
[proxy url]:  POST  /proxy-default/api/auth/login
[real request url]: http://localhost:5001/api/auth/login
```
✅ 代理正确转发请求

### 2. 验证后端API
```bash
Invoke-RestMethod -Uri "http://localhost:5001/api/auth/login" `
  -Method POST `
  -Body '{"username":"admin","password":"admin123"}' `
  -ContentType "application/json"
```
返回:
```json
{
  "code": 0,
  "msg": "登录成功，欢迎回来！",
  "data": {
    "id": 2,
    "username": "admin",
    "role": "admin",
    "access_token": "eyJ...",
    "refresh_token": "eyJ...",
    "expires": 1765448481000
  }
}
```
✅ 后端API工作正常

### 3. 验证前端登录
1. 访问 http://localhost:9530/
2. 输入账号: `admin` / `admin123`
3. 点击登录

预期结果:
- ✅ 登录成功
- ✅ Token 存储到 localStorage
- ✅ 跳转到首页

---

## 技术细节

### Vite 代理工作原理
```
浏览器请求
  ↓
http://localhost:9530/proxy-default/api/auth/login
  ↓
Vite Dev Server 代理拦截
  ↓
路径重写: /proxy-default → ''
  ↓
转发到后端: http://localhost:5001/api/auth/login
  ↓
Go 后端处理
  ↓
返回响应
```

### 请求拦截器逻辑
```typescript
async onRequest(config) {
  const Authorization = getAuthorization();  // 如果没有token返回null
  Object.assign(config.headers, { Authorization });
  return config;
}
```

**注意**: 
- 登录时 `Authorization` 为 `null`（localStorage中没有token）
- 登录成功后，token存储到 localStorage
- 后续请求会自动带上 `Authorization: Bearer <token>` header

---

## 常见错误排查

### 如果登录仍然失败

1. **检查后端服务是否运行**
   ```bash
   Get-Process | Where-Object {$_.Name -like "*jd-task*"}
   ```

2. **检查环境变量配置**
   ```bash
   cd "d:\工程\测试vue项目\soybean-admin"
   Get-Content .env.test | Select-String "VITE_SERVICE_BASE_URL"
   ```
   应该显示: `VITE_SERVICE_BASE_URL=http://localhost:5001`

3. **检查代理日志**
   在 Vite 控制台查看是否有代理转发日志

4. **检查浏览器控制台**
   - Network 面板查看请求详情
   - 请求URL、Headers、Response
   - 确认返回的状态码和响应内容

5. **清除浏览器缓存**
   - 清除 localStorage
   - 刷新页面重试

---

## 后续注意事项

### 开发环境
- ✅ 使用 `pnpm dev` 启动
- ✅ 后端地址: `http://localhost:5001`
- ✅ 代理已启用

### 生产环境
- ⚠️ 发布前修改 `.env.production`
- ⚠️ 设置正确的生产环境域名
- ⚠️ 使用 `.\build-production.ps1` 构建

---

**修复完成时间**: 2025-12-11  
**状态**: ✅ 问题已解决，登录功能正常
