# JD任务平台前端 - 环境配置说明

## ✅ 问题已解决

**问题**: 登录API返回404错误  
**原因**: 启动时使用了 `test` 模式，`.env.test` 文件中配置的后端地址是 Apifox Mock 地址  
**解决**: 已修改 `.env.test` 文件，指向本地 Go 后端服务

---

## 📁 当前环境配置文件

### 1. `.env` - 基础配置（所有环境共享）
```env
VITE_SERVICE_BASE_URL=http://localhost:5001
VITE_SERVICE_API_PREFIX=/api
VITE_SERVICE_SUCCESS_CODE=0
VITE_HTTP_PROXY=Y
```

### 2. `.env.development` - 开发环境
```env
VITE_SERVICE_BASE_URL=http://localhost:5001
```

### 3. `.env.test` - 测试环境（当前使用）✅
```env
VITE_SERVICE_BASE_URL=http://localhost:5001  # 已修改为本地Go后端
```

### 4. `.env.production` - 生产环境
```env
VITE_SERVICE_BASE_URL=https://your-production-domain.com  # 需要修改为实际域名
```

---

## 🚀 启动说明

### 当前启动命令
```bash
pnpm dev
```
- 实际执行: `vite --mode test`
- 加载配置: `.env` + `.env.test`
- 后端地址: `http://localhost:5001` ✅

### 访问地址
- **前端**: http://localhost:9530/ (端口可能变化)
- **后端**: http://localhost:5001
- **后端API**: http://localhost:5001/api

### 测试账号
- **管理员**: `admin` / `admin123`
- **普通用户**: `user001` / `pass123`

---

## 🔧 Vite 代理工作原理

### 开发环境下的请求流程

1. **前端发起请求**: `POST /proxy-default/api/auth/login`
2. **Vite 代理拦截**: 匹配 `/proxy-default` 路径
3. **路径重写**: 去掉 `/proxy-default` → `/api/auth/login`
4. **转发到后端**: `http://localhost:5001/api/auth/login`
5. **后端处理**: Go 服务器处理请求
6. **返回响应**: 通过代理返回给前端

### 代理配置位置
- **配置文件**: `build/config/proxy.ts`
- **工具函数**: `src/utils/service.ts`
- **启用条件**: 开发环境 + `VITE_HTTP_PROXY=Y`

---

## 🌐 不同启动模式对比

| 启动命令 | 模式 | 配置文件 | 后端地址 | 用途 |
|----------|------|----------|----------|------|
| `pnpm dev` | test | `.env.test` | `http://localhost:5001` ✅ | 本地联调开发 |
| `vite --mode development` | development | `.env.development` | `http://localhost:5001` | 开发模式 |
| `pnpm build` | production | `.env.production` | 生产域名 | 生产构建 |

---

## 📝 后续发布流程

### 1. 修改生产环境配置
编辑 `.env.production` 文件：
```env
VITE_SERVICE_BASE_URL=https://api.yourdomain.com
```

### 2. 执行生产构建
```bash
# 使用快速构建脚本
.\build-production.ps1

# 或手动构建
pnpm build
```

### 3. 部署 dist 目录
将生成的 `dist` 目录上传到服务器

### 4. 配置 Nginx（示例）
```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # 前端静态文件
    location / {
        root /var/www/jd-task-platform/frontend;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理（可选，如果前后端同域名）
    location /api {
        proxy_pass http://localhost:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## 🐛 常见问题排查

### 1. 登录返回 404
**检查项**:
- [ ] 后端服务是否运行: `Get-Process | Where-Object {$_.Name -like "*jd-task*"}`
- [ ] 后端API是否可访问: `Invoke-RestMethod http://localhost:5001/api/auth/login`
- [ ] 环境变量配置是否正确: 查看 `.env.test`
- [ ] 代理是否启用: `VITE_HTTP_PROXY=Y`

### 2. CORS 跨域错误
**原因**: 后端未配置 CORS  
**解决**: Go 后端已配置 Gin CORS 中间件，应该不会出现此问题

### 3. Token 认证失败
**检查项**:
- [ ] 登录后 Token 是否存储: 查看浏览器 localStorage
- [ ] 请求头是否包含 Authorization: 查看 Network 面板
- [ ] Token 格式是否正确: `Bearer <token>`

---

## 📖 相关文档

- [部署指南](./DEPLOYMENT.md) - 生产环境部署详细说明
- [后端对接文档](./BACKEND_INTEGRATION.md) - API 对接详细说明
- [构建脚本](./build-production.ps1) - 一键构建生产版本

---

## ✨ 开发建议

1. **本地开发**: 使用当前 `pnpm dev` 命令即可
2. **环境隔离**: 不同环境使用对应的配置文件
3. **生产发布**: 使用 `build-production.ps1` 脚本检查配置
4. **测试验证**: 发布前先测试登录、创建任务等核心功能

---

**最后更新**: 2025-12-11  
**状态**: ✅ 已配置完成，可以正常开发
