# 设备密钥认证功能说明

## 🔐 功能概述

本次更新将设备端API认证从APIKey机制改为**固定密钥认证**：

- **认证方式**: 设备使用固定密钥进行认证，而不是每个用户的API Key
- **密钥管理**: 管理员可以在系统设置页面查看和修改设备密钥
- **初始密钥**: `KKNN778899`（可在系统设置中修改）
- **密钥要求**: 长度必须大于6位

---

## 📋 修改内容

### 1. 后端修改

#### 新增文件

**`internal/middleware/device_key.go`** - 设备密钥认证中间件
```go
// 验证请求头中的 X-Device-Key 是否与数据库配置匹配
func DeviceKeyMiddleware(db *gorm.DB) gin.HandlerFunc
```

#### 修改文件

**`internal/handlers/setting.go`** - 添加密钥管理接口
- `GetDeviceAuthKey()` - 获取当前设备密钥
- `UpdateDeviceAuthKey()` - 更新设备密钥（需验证长度>6）

**`main.go`** - 更新路由配置
- `/api/devices/*` 路由改用 `DeviceKeyMiddleware`
- `/api/proxy/assign` 路由改用 `DeviceKeyMiddleware`
- 新增 `/api/settings/device-key` 接口（GET/PUT）

**`scripts/init_data.sql`** - 数据库初始化脚本
- 新增 `device_auth_key` 配置项，默认值 `KKNN778899`

---

### 2. iOS 脚本修改

#### 修改文件

**`config.py`** - 配置文件
- 新增 `DEVICE_AUTH_KEY = "KKNN778899"` 配置
- 更新API路径：
  - `API_TASK_GET` → `/api/devices/request-task`
  - 新增 `API_TASK_FEEDBACK` → `/api/devices/task-feedback`

**`api_client.py`** - API客户端
- 导入 `DEVICE_AUTH_KEY`
- 所有请求自动添加 `X-Device-Key` 请求头
- 合并 `update_task_status` 和 `complete_task` 为 `task_feedback`

---

## 🚀 部署步骤

### 步骤 1: 更新数据库

运行初始化脚本插入设备密钥配置：

```powershell
# 在 PowerShell 中执行
cd d:\工程\jd-task-platform-go\scripts
.\initialize.ps1
```

或手动执行 SQL：

```sql
INSERT INTO settings (param_key, param_value, param_type, description, updated_at) 
VALUES ('device_auth_key', 'KKNN778899', 'string', '设备认证密钥（用于设备端API认证）', NOW())
ON DUPLICATE KEY UPDATE 
    param_value = VALUES(param_value),
    updated_at = NOW();
```

---

### 步骤 2: 重启后端服务

```powershell
# 停止当前服务（Ctrl+C）

# 重新编译并启动
cd d:\工程\jd-task-platform-go
go build -o jd-platform.exe
.\jd-platform.exe
```

---

### 步骤 3: 验证后端接口

#### 测试获取密钥（需要管理员登录）

```powershell
# 先登录获取 token
$loginResp = Invoke-RestMethod -Uri "http://192.168.0.108:5001/api/auth/login" `
    -Method POST `
    -ContentType "application/json" `
    -Body '{"username":"admin","password":"admin123"}'

$token = $loginResp.data.token

# 获取设备密钥
Invoke-RestMethod -Uri "http://192.168.0.108:5001/api/settings/device-key" `
    -Method GET `
    -Headers @{Authorization="Bearer $token"}
```

#### 测试使用密钥请求任务

```powershell
# 使用设备密钥请求任务
Invoke-RestMethod -Uri "http://192.168.0.108:5001/api/devices/request-task" `
    -Method POST `
    -ContentType "application/json" `
    -Headers @{"X-Device-Key"="KKNN778899"} `
    -Body '{"device_id":"test123"}'
```

---

### 步骤 4: iOS 脚本无需修改

iOS 脚本配置已自动更新，直接运行即可：

1. 脚本会自动在所有API请求中添加 `X-Device-Key: KKNN778899` 请求头
2. 使用新的API路径 `/api/devices/request-task`

---

## 🎨 前端页面修改

需要在**系统设置页面**添加设备密钥管理功能。

### API 接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取密钥 | GET | `/api/settings/device-key` | 返回当前密钥 |
| 更新密钥 | PUT | `/api/settings/device-key` | 更新密钥（≥6位） |

### 前端实现建议

在系统设置页面添加以下内容：

```vue
<template>
  <div class="设备密钥管理">
    <a-card title="设备认证密钥">
      <a-form-item label="当前密钥">
        <a-input-password 
          v-model:value="deviceKey" 
          placeholder="请输入设备密钥（至少6位）"
        />
      </a-form-item>
      
      <a-button type="primary" @click="updateDeviceKey">
        更新密钥
      </a-button>
      
      <div class="hint">
        <a-alert 
          message="提示" 
          description="设备密钥用于iOS设备端API认证，修改后需同步更新iOS脚本配置文件中的DEVICE_AUTH_KEY"
          type="info" 
          show-icon 
        />
      </div>
    </a-card>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { message } from 'ant-design-vue'
import { request } from '@/utils/request'

const deviceKey = ref('')

// 获取当前密钥
const fetchDeviceKey = async () => {
  try {
    const res = await request.get('/settings/device-key')
    deviceKey.value = res.data.device_key
  } catch (error) {
    message.error('获取设备密钥失败')
  }
}

// 更新密钥
const updateDeviceKey = async () => {
  if (!deviceKey.value || deviceKey.value.length < 6) {
    message.error('设备密钥长度必须大于6位')
    return
  }
  
  try {
    await request.put('/settings/device-key', {
      device_key: deviceKey.value
    })
    message.success('设备密钥更新成功')
  } catch (error) {
    message.error(error.msg || '更新密钥失败')
  }
}

onMounted(() => {
  fetchDeviceKey()
})
</script>
```

### 添加位置

建议添加到：

- **路径**: `src/views/system/settings/index.vue`
- **位置**: 系统设置页面的"安全设置"或"高级设置"部分

---

## 🔒 安全说明

### 密钥存储

- ✅ 密钥存储在数据库 `settings` 表中
- ✅ 仅管理员可以查看和修改
- ✅ iOS脚本配置文件中明文存储（脚本在设备本地）

### 认证流程

```
iOS设备 → 发送请求（携带 X-Device-Key 请求头）
    ↓
后端中间件 → 从数据库读取 device_auth_key
    ↓
比对密钥 → 一致则通过，否则返回 401
```

### 优势

1. **集中管理**: 所有设备使用同一密钥，便于管理
2. **易于更新**: 修改密钥后，只需更新iOS脚本配置文件
3. **安全性**: 仅管理员可修改，支持定期更换

### 注意事项

⚠️ **修改密钥后，需要同步更新：**

1. iOS脚本配置文件 `config.py` 中的 `DEVICE_AUTH_KEY`
2. 所有正在运行的设备需要重启脚本

---

## 📊 影响范围

### 受影响的API接口

以下接口改为使用设备密钥认证：

| 接口 | 原认证方式 | 新认证方式 |
|------|-----------|-----------|
| POST /api/devices/request-task | API Key | 设备密钥 |
| POST /api/devices/task-feedback | API Key | 设备密钥 |
| POST /api/proxy/assign | API Key | 设备密钥 |

### 不受影响的API接口

以下接口仍使用原有的APIKey认证：

- `/api/openapi/*` - 开放API（用户API Key）
- `/api/jingdou/balance/apikey` - 京豆余额查询
- `/api/logs/apikey` - API日志查询

---

## ✅ 测试清单

- [ ] 数据库中存在 `device_auth_key` 配置
- [ ] 后端服务正常启动
- [ ] 管理员可以获取设备密钥
- [ ] 管理员可以修改设备密钥
- [ ] 设备使用正确密钥可以请求任务
- [ ] 设备使用错误密钥返回 401
- [ ] iOS脚本可以正常连接并获取任务
- [ ] 前端页面显示密钥管理功能

---

## 🆘 常见问题

### Q1: 修改密钥后iOS设备无法连接？

**A**: 检查 iOS 脚本 `config.py` 中的 `DEVICE_AUTH_KEY` 是否与后端一致。

### Q2: 如何重置密钥？

**A**: 登录管理员账号，在系统设置页面修改，或直接修改数据库：

```sql
UPDATE settings 
SET param_value = 'KKNN778899', updated_at = NOW() 
WHERE param_key = 'device_auth_key';
```

### Q3: 密钥在哪里配置？

**A**: 
- 后端：数据库 `settings` 表，`param_key='device_auth_key'`
- iOS脚本：`jdios/config.py`，`DEVICE_AUTH_KEY`

---

## 📝 后续优化建议

1. **密钥加密存储**: 在数据库中使用加密存储密钥
2. **密钥历史**: 记录密钥修改历史
3. **密钥轮换**: 定期提醒管理员更换密钥
4. **多密钥支持**: 支持同时配置多个密钥，便于灰度切换

---

**版本**: v1.0  
**更新时间**: 2024-12-15  
**作者**: AI Assistant
