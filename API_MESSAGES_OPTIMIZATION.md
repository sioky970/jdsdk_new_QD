# API 返回消息优化方案

## 📋 审计总结

通过对所有handler文件的审计，发现以下问题：

### 当前存在的问题

1. **❌ 消息不够友好**
   - 部分消息过于简短，如"用户不存在"、"请求参数错误"
   - 缺少用户操作建议
   - 技术性词汇过多（如"Token"、"API密钥"）

2. **❌ 消息不一致**
   - 同样的错误在不同地方描述不同
   - 成功消息使用混乱（有些有，有些没有）

3. **❌ 缺少上下文信息**
   - 错误消息不能帮助用户定位问题
   - 没有提供解决方案提示

## 🎯 优化原则

### 1. 友好性原则
- 使用用户能理解的语言
- 避免技术术语，用业务术语代替
- 提供帮助性信息

### 2. 一致性原则
- 相同类型的错误使用相同的消息模板
- 统一成功/失败消息格式

### 3. 有效性原则
- 准确描述问题
- 提供解决建议
- 包含必要的上下文信息

## 📊 优化方案

### 一、认证模块 (auth.go)

#### 当前消息 → 优化后消息

| 场景 | 当前消息 | 优化后消息 | 说明 |
|------|---------|----------|------|
| 注册-参数错误 | "请求参数错误" | "注册信息填写不完整，请检查用户名和密码" | 更具体 |
| 注册-用户名重复 | "用户名已存在" | "该用户名已被注册，请换一个用户名试试" | 更友好 |
| 注册-密码加密失败 | "密码加密失败" | "系统繁忙，请稍后重试" | 隐藏技术细节 |
| 注册-创建失败 | "用户创建失败" | "注册失败，请稍后重试或联系管理员" | 提供建议 |
| 注册-成功 | (无) | "注册成功，欢迎加入！" | 添加成功提示 |
| 登录-参数错误 | "请求参数错误" | "请输入用户名和密码" | 更明确 |
| 登录-认证失败 | "用户名或密码错误" | "用户名或密码不正确，请重新输入" | 更友好 |
| 登录-Token失败 | "Token生成失败" | "登录会话创建失败，请重试" | 用户化 |
| 登录-成功 | (无) | "登录成功，欢迎回来！" | 添加欢迎语 |
| 刷新-参数错误 | "请求参数错误" | "登录已过期，请重新登录" | 说明原因 |
| 刷新-Token无效 | "令牌无效或已过期" | "登录已过期，请重新登录" | 简化表述 |
| 刷新-成功 | (无) | "登录状态已刷新" | 添加提示 |
| 登出-成功 | "登出成功" | "已安全退出，期待您再次光临！" | 更温馨 |

### 二、用户模块 (user.go, user_extended.go)

| 场景 | 当前消息 | 优化后消息 |
|------|---------|----------|
| 获取信息-用户不存在 | "用户不存在" | "未找到该用户信息" |
| 修改密码-参数错误 | "请求参数错误" | "请输入旧密码和新密码" |
| 修改密码-旧密码错误 | "旧密码不正确" | "当前密码输入错误，请重新输入" |
| 修改密码-密码太短 | "新密码长度不能少于6位" | "新密码至少需要6个字符，请重新设置" |
| 修改密码-成功 | (无) | "密码修改成功，请使用新密码登录" |
| 生成API密钥-成功 | (无) | "API密钥已生成，请妥善保管" |
| 创建用户-用户名重复 | "用户名已存在" | "该用户名已被使用，请换一个" |
| 调整京豆-余额不足 | "京豆余额不足" | "京豆余额不足，无法完成扣减" |
| 充值京豆-成功 | (无) | "京豆充值成功！" |

### 三、任务模块 (task.go, task_extended.go)

| 场景 | 当前消息 | 优化后消息 |
|------|---------|----------|
| 创建任务-参数错误 | "请求参数错误" | "任务信息不完整，请检查必填项" |
| 创建任务-用户不存在 | "用户不存在" | "用户信息异常，请重新登录" |
| 创建任务-无效类型 | "无效的任务类型" | "选择的任务类型不存在，请重新选择" |
| 创建任务-类型禁用 | "该任务类型已禁用" | "该任务类型暂时不可用，请选择其他类型" |
| 创建任务-时间段限制 | "当前时间不在允许创建任务的时间段内（...）" | "该任务类型仅在 {{时间段}} 开放创建" |
| 创建任务-余额不足 | "京豆余额不足" | "京豆余额不足，当前需要 {{价格}} 京豆，您的余额为 {{余额}} 京豆" |
| 创建任务-创建失败 | "任务创建失败" | "任务创建失败，请稍后重试" |
| 创建任务-成功 | (无) | "任务创建成功！已消耗 {{京豆}} 京豆" |
| 取消任务-无权限 | "无权取消此任务" | "您没有权限取消该任务" |
| 取消任务-状态错误 | "只有等待中的任务可以取消" | "只有等待执行的任务可以取消" |
| 取消任务-成功 | (无) | "任务已取消，{{京豆}} 京豆已退还" |
| 创建类型-禁止 | "系统已预设所有任务类型，不允许创建新类型" | "系统已预设所有任务类型，如需调整请联系管理员" |
| 更新类型-成功 | "任务类型更新成功" | "任务类型配置已更新" |
| 批量创建-空列表 | "任务列表不能为空" | "请至少添加一个任务" |
| 批量创建-超限 | "单次最多创建100个任务" | "一次最多可创建100个任务，请分批提交" |
| 批量创建-成功 | (无) | "成功创建 {{成功数}} 个任务，共消耗 {{京豆}} 京豆" |

### 四、设备模块 (device.go, device_extended.go)

| 场景 | 当前消息 | 优化后消息 |
|------|---------|----------|
| 获取设备-不存在 | "设备不存在" | "未找到该设备信息" |
| 更新状态-参数错误 | "请求参数错误" | "设备状态信息不正确" |
| 更新状态-成功 | (无) | "设备状态已更新" |
| 请求任务-参数错误 | "请求参数错误" | "设备信息不完整" |
| 请求任务-无任务 | (无) | "暂无可执行任务" |
| 请求任务-成功 | (无) | "任务分配成功" |
| 任务反馈-不存在 | "任务不存在" | "未找到该任务，可能已被取消" |
| 任务反馈-成功 | (无) | "任务执行结果已提交" |
| 清空设备-成功 | (无) | "所有设备数据已清空" |

### 五、京豆模块 (jingdou.go)

| 场景 | 当前消息 | 优化后消息 |
|------|---------|----------|
| 获取余额-用户不存在 | "用户不存在" | "用户信息异常，请重新登录" |
| 获取日志-成功 | (无) | 保持静默（列表查询无需提示） |

### 六、设置模块 (setting.go)

| 场景 | 当前消息 | 优化后消息 |
|------|---------|----------|
| 解析失败 | "配置解析失败" | "配置数据格式错误" |
| 保存-参数错误 | "请求参数错误" | "配置信息不完整" |
| 保存-序列化失败 | "配置序列化失败" | "配置保存失败，请重试" |
| 保存-成功 | (无) | "配置已保存" |
| 更新-不存在 | "设置不存在" | "配置项不存在" |
| 更新-成功 | (无) | "设置已更新" |
| 初始化-成功 | (无) | "默认配置已初始化" |

### 七、API密钥模块 (apikey.go)

| 场景 | 当前消息 | 优化后消息 |
|------|---------|----------|
| 获取-用户不存在 | "用户不存在" | "用户信息异常" |
| 获取-成功 | (无) | 保持静默 |
| 刷新-用户不存在 | "用户不存在" | "用户信息异常" |
| 刷新-成功 | (无) | "API密钥已刷新，旧密钥已失效" |

## 🔧 实施建议

### 1. 创建消息常量文件

创建 `internal/constants/messages.go`:

```go
package constants

// 通用消息
const (
    MsgSuccess = "操作成功"
    MsgSystemBusy = "系统繁忙，请稍后重试"
    MsgParamError = "请求参数错误"
    MsgUnauthorized = "未授权或登录已过期"
    MsgForbidden = "无权执行此操作"
    MsgNotFound = "未找到相关信息"
)

// 认证模块
const (
    MsgRegisterSuccess = "注册成功，欢迎加入！"
    MsgRegisterParamError = "注册信息填写不完整，请检查用户名和密码"
    MsgUsernameExists = "该用户名已被注册，请换一个用户名试试"
    MsgRegisterFailed = "注册失败，请稍后重试或联系管理员"
    
    MsgLoginSuccess = "登录成功，欢迎回来！"
    MsgLoginParamError = "请输入用户名和密码"
    MsgLoginFailed = "用户名或密码不正确，请重新输入"
    MsgLoginSessionFailed = "登录会话创建失败，请重试"
    
    MsgLogoutSuccess = "已安全退出，期待您再次光临！"
    MsgTokenExpired = "登录已过期，请重新登录"
    MsgTokenRefreshed = "登录状态已刷新"
)

// 用户模块
const (
    MsgUserNotFound = "未找到该用户信息"
    MsgPasswordChanged = "密码修改成功，请使用新密码登录"
    MsgPasswordWrong = "当前密码输入错误，请重新输入"
    MsgPasswordTooShort = "新密码至少需要6个字符，请重新设置"
    MsgAPIKeyGenerated = "API密钥已生成，请妥善保管"
    MsgAPIKeyRefreshed = "API密钥已刷新，旧密钥已失效"
)

// 任务模块
const (
    MsgTaskCreated = "任务创建成功！已消耗 %d 京豆"
    MsgTaskCreateParamError = "任务信息不完整，请检查必填项"
    MsgTaskTypeInvalid = "选择的任务类型不存在，请重新选择"
    MsgTaskTypeDisabled = "该任务类型暂时不可用，请选择其他类型"
    MsgTaskTimeSlotLimit = "该任务类型仅在 %s 开放创建"
    MsgTaskBalanceInsufficient = "京豆余额不足，当前需要 %d 京豆，您的余额为 %d 京豆"
    MsgTaskNotFound = "未找到该任务，可能已被取消"
    MsgTaskCancelled = "任务已取消，%d 京豆已退还"
    MsgTaskCannotCancel = "只有等待执行的任务可以取消"
    MsgTaskNoPermission = "您没有权限操作该任务"
    
    MsgTaskTypePreset = "系统已预设所有任务类型，如需调整请联系管理员"
    MsgTaskTypeUpdated = "任务类型配置已更新"
    
    MsgBatchTaskEmpty = "请至少添加一个任务"
    MsgBatchTaskLimit = "一次最多可创建100个任务，请分批提交"
    MsgBatchTaskCreated = "成功创建 %d 个任务，共消耗 %d 京豆"
)

// 设备模块
const (
    MsgDeviceNotFound = "未找到该设备信息"
    MsgDeviceStatusUpdated = "设备状态已更新"
    MsgDeviceNoTask = "暂无可执行任务"
    MsgDeviceTaskAssigned = "任务分配成功"
    MsgDeviceTaskFeedback = "任务执行结果已提交"
    MsgDeviceCleared = "所有设备数据已清空"
)

// 京豆模块
const (
    MsgJingdouRecharged = "京豆充值成功！"
    MsgJingdouInsufficient = "京豆余额不足，无法完成扣减"
)

// 设置模块
const (
    MsgSettingSaved = "配置已保存"
    MsgSettingUpdated = "设置已更新"
    MsgSettingInitialized = "默认配置已初始化"
    MsgSettingParamError = "配置信息不完整"
    MsgSettingNotFound = "配置项不存在"
)
```

### 2. 修改response包

更新 `pkg/response/response.go` 支持格式化消息:

```go
// SuccessWithMsgf 格式化成功消息
func SuccessWithMsgf(c *gin.Context, format string, args ...interface{}) {
    msg := fmt.Sprintf(format, args...)
    SuccessWithMsg(c, msg, nil)
}

// Errorf 格式化错误消息
func Errorf(c *gin.Context, code int, format string, args ...interface{}) {
    msg := fmt.Sprintf(format, args...)
    Error(c, code, msg)
}
```

### 3. 逐步替换现有消息

按模块优先级替换：
1. 认证模块（高频使用）
2. 任务模块（核心功能）
3. 用户模块
4. 其他模块

### 4. 前端适配

前端需要适配新的消息格式：
- 直接展示 `msg` 字段（已经是友好消息）
- 移除前端的消息映射逻辑
- 统一使用后端返回的消息

## 📈 预期效果

### 优化前
```json
{
  "code": 400,
  "msg": "京豆余额不足"
}
```

用户体验：❌ 不知道还需要多少京豆

### 优化后
```json
{
  "code": 400,
  "msg": "京豆余额不足，当前需要 50 京豆，您的余额为 30 京豆"
}
```

用户体验：✅ 清楚知道差额，可以决定是否充值

## 🚀 实施计划

### 第一阶段（高优先级）
- [ ] 创建消息常量文件
- [ ] 更新response包支持格式化
- [ ] 优化认证模块消息
- [ ] 优化任务模块消息

### 第二阶段（中优先级）
- [ ] 优化用户模块消息
- [ ] 优化设备模块消息
- [ ] 优化京豆模块消息

### 第三阶段（低优先级）
- [ ] 优化设置模块消息
- [ ] 优化API密钥模块消息
- [ ] 完善文档

### 第四阶段（测试与反馈）
- [ ] 全量测试
- [ ] 收集用户反馈
- [ ] 持续优化

## 📝 示例对比

### 示例1：创建任务

**优化前**:
```
请求参数错误
```

**优化后**:
```
任务信息不完整，请检查必填项
```

### 示例2：取消任务

**优化前**:
```
(无提示消息)
```

**优化后**:
```
任务已取消，50 京豆已退还
```

### 示例3：批量创建

**优化前**:
```
(无提示消息)
```

**优化后**:
```
成功创建 8 个任务，共消耗 40 京豆
```

---

**文档版本**: v1.0  
**创建时间**: 2025-12-11  
**维护者**: AI Assistant
