# ç®¡ç†å‘˜æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜æè¿°

ç”¨æˆ·ä½¿ç”¨adminè´¦æˆ·ç™»å½•åï¼Œè®¿é—®éœ€è¦ç®¡ç†å‘˜æƒé™çš„åŠŸèƒ½ï¼ˆå¦‚ä¿®æ”¹ç³»ç»Ÿé…ç½®ï¼‰æ—¶æç¤ºï¼š**"éœ€è¦ç®¡ç†å‘˜æƒé™"**

## ğŸ¯ é—®é¢˜æ ¹æº

**JWT Tokenä¸­çš„roleå­—æ®µæ˜¯æ—§å€¼ï¼**

### åŸå› åˆ†æ

1. ç”¨æˆ·åœ¨ä¹‹å‰æŸä¸ªæ—¶é—´ç‚¹ç™»å½•è·å–äº†JWT token
2. ä¹‹åæ•°æ®åº“ä¸­çš„ç”¨æˆ·roleè¢«æ›´æ–°ä¸º`admin`
3. ä½†ç”¨æˆ·æµè§ˆå™¨/å‰ç«¯ä»ç„¶ä½¿ç”¨æ—§çš„JWT tokenï¼ˆå…¶ä¸­roleå¯èƒ½æ˜¯`common`æˆ–å…¶ä»–å€¼ï¼‰
4. åç«¯æƒé™éªŒè¯ä¸­é—´ä»¶æ£€æŸ¥tokenä¸­çš„roleå­—æ®µï¼Œè€Œä¸æ˜¯å®æ—¶æŸ¥è¯¢æ•°æ®åº“
5. å› æ­¤å³ä½¿æ•°æ®åº“ä¸­roleå·²ç»æ˜¯adminï¼Œæ—§tokenä¸­çš„roleä»ç„¶æ˜¯æ—§å€¼

### JWTå·¥ä½œåŸç†

```
JWT Tokenç»“æ„ï¼š
Header.Payload.Signature

Payloadä¸­åŒ…å«ï¼š
{
  "user_id": 1,
  "username": "admin",
  "role": "common",  â† è¿™æ˜¯ç”Ÿæˆtokenæ—¶çš„å€¼ï¼Œä¸ä¼šè‡ªåŠ¨æ›´æ–°
  "exp": 1765744274,
  "iat": 1765740674
}
```

**å…³é”®ç‚¹**ï¼šJWTæ˜¯æ— çŠ¶æ€çš„ï¼Œtokenä¸€æ—¦ç”Ÿæˆï¼Œå…¶ä¸­çš„æ•°æ®å°±å›ºå®šäº†ï¼Œä¸ä¼šå› ä¸ºæ•°æ®åº“æ›´æ–°è€Œæ”¹å˜ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šé‡æ–°ç™»å½•ï¼ˆæ¨èï¼‰

**æœ€ç®€å•æœ‰æ•ˆçš„æ–¹æ³•**ï¼šé€€å‡ºç™»å½•ï¼Œé‡æ–°ç™»å½•è·å–æ–°çš„JWT token

#### æ­¥éª¤ï¼š
1. åœ¨å‰ç«¯ç‚¹å‡»"é€€å‡ºç™»å½•"
2. é‡æ–°è¾“å…¥è´¦å·å¯†ç ç™»å½•
3. æ–°tokenä¸­çš„roleå­—æ®µä¼šæ˜¯æœ€æ–°çš„`admin`å€¼

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨åˆ·æ–°token API

å¦‚æœä¸æƒ³è®©ç”¨æˆ·é‡æ–°è¾“å…¥å¯†ç ï¼Œå¯ä»¥è°ƒç”¨åˆ·æ–°tokenæ¥å£ï¼š

```bash
POST http://localhost:5001/api/auth/refresh
Content-Type: application/json

{
  "refresh_token": "ç”¨æˆ·çš„refresh_token"
}
```

**æ³¨æ„**ï¼šè¿™ä¸ªæ–¹æ¡ˆæœ‰ä¸ªé—®é¢˜ - åˆ·æ–°tokenæ—¶ä½¿ç”¨çš„æ˜¯æ—§refresh_tokenä¸­çš„roleå€¼ï¼Œæ‰€ä»¥å¦‚æœæ—§refresh_tokenä¸­roleä¹Ÿæ˜¯é”™çš„ï¼Œåˆ·æ–°åä»ç„¶æ˜¯é”™çš„ã€‚

### æ–¹æ¡ˆ3ï¼šä¿®æ”¹åç«¯é€»è¾‘ï¼ˆä¸æ¨èï¼Œä¼šå½±å“æ€§èƒ½ï¼‰

å¯ä»¥ä¿®æ”¹æƒé™éªŒè¯ä¸­é—´ä»¶ï¼Œæ¯æ¬¡éƒ½ä»æ•°æ®åº“æŸ¥è¯¢æœ€æ–°çš„ç”¨æˆ·roleï¼š

```go
// AdminMiddleware ç®¡ç†å‘˜æƒé™ä¸­é—´ä»¶ï¼ˆå®æ—¶æŸ¥è¯¢ç‰ˆæœ¬ï¼‰
func AdminMiddleware(db *gorm.DB) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID, _ := c.Get("user_id")
        
        var user models.User
        if err := db.First(&user, userID).Error; err != nil {
            response.Error(c, http.StatusForbidden, "ç”¨æˆ·ä¸å­˜åœ¨")
            c.Abort()
            return
        }
        
        if user.Role != "admin" {
            response.Error(c, http.StatusForbidden, "éœ€è¦ç®¡ç†å‘˜æƒé™")
            c.Abort()
            return
        }
        c.Next()
    }
}
```

**ç¼ºç‚¹**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½æŸ¥è¯¢æ•°æ®åº“ï¼Œå½±å“æ€§èƒ½ã€‚

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥æ•°æ®åº“ä¸­çš„ç”¨æˆ·è§’è‰²

```bash
docker exec jd-task-mysql mysql -uroot -p123456 jd \
  --default-character-set=utf8mb4 \
  -e "SELECT id, username, role FROM users WHERE username='admin';"
```

é¢„æœŸè¾“å‡ºï¼š
```
+----+----------+-------+
| id | username | role  |
+----+----------+-------+
|  1 | admin    | admin |
+----+----------+-------+
```

### 2. é‡æ–°ç™»å½•è·å–æ–°token

```powershell
$loginResponse = Invoke-RestMethod `
  -Uri "http://localhost:5001/api/auth/login" `
  -Method POST `
  -Body (@{username="admin"; password="admin123"} | ConvertTo-Json) `
  -ContentType "application/json"

# æŸ¥çœ‹è¿”å›çš„role
$loginResponse.data.role  # åº”è¯¥æ˜¾ç¤º "admin"
```

### 3. ä½¿ç”¨æ–°tokenæµ‹è¯•ç®¡ç†å‘˜æƒé™

```powershell
$headers = @{"Authorization" = "Bearer $($loginResponse.data.access_token)"}

$settings = Invoke-RestMethod `
  -Uri "http://localhost:5001/api/settings" `
  -Headers $headers `
  -Method GET

# æˆåŠŸè¿”å›ç³»ç»Ÿè®¾ç½®åˆ—è¡¨
$settings.data.settings
```

## ğŸ“‹ å‰ç«¯æ“ä½œæ­¥éª¤

1. **é€€å‡ºç™»å½•**
   - ç‚¹å‡»å³ä¸Šè§’ç”¨æˆ·å¤´åƒ
   - é€‰æ‹©"é€€å‡ºç™»å½•"
   
2. **é‡æ–°ç™»å½•**
   - è¾“å…¥è´¦å·ï¼š`admin`
   - è¾“å…¥å¯†ç ï¼š`admin123`
   - ç‚¹å‡»"ç™»å½•"

3. **éªŒè¯æƒé™**
   - å°è¯•è®¿é—®ç³»ç»Ÿè®¾ç½®é¡µé¢
   - å°è¯•ä¿®æ”¹ç³»ç»Ÿé…ç½®
   - åº”è¯¥å¯ä»¥æ­£å¸¸æ“ä½œï¼Œä¸å†æç¤ºæƒé™é”™è¯¯

## ğŸ”’ æƒé™éªŒè¯æµç¨‹

```
ç”¨æˆ·è¯·æ±‚
  â†“
æå–Authorizationå¤´
  â†“
è§£æJWT token
  â†“
ä»tokençš„payloadä¸­è·å–role  â† è¿™é‡Œä½¿ç”¨çš„æ˜¯tokenä¸­çš„å€¼ï¼Œä¸æ˜¯æ•°æ®åº“çš„å€¼
  â†“
æ£€æŸ¥ role == "admin" ?
  â†“
  æ˜¯ â†’ å…è®¸è®¿é—®
  å¦ â†’ è¿”å›403 "éœ€è¦ç®¡ç†å‘˜æƒé™"
```

## ğŸ’¡ æœ€ä½³å®è·µ

### è§’è‰²å˜æ›´æ—¶çš„å¤„ç†

å½“ç”¨æˆ·çš„è§’è‰²åœ¨æ•°æ®åº“ä¸­è¢«ä¿®æ”¹æ—¶ï¼ˆå¦‚ä»commonå‡çº§ä¸ºadminï¼‰ï¼Œåº”è¯¥ï¼š

1. **é€šçŸ¥ç”¨æˆ·é‡æ–°ç™»å½•**
   - å‘é€ç³»ç»Ÿæ¶ˆæ¯
   - æˆ–å¼ºåˆ¶ç”¨æˆ·é€€å‡ºç™»å½•

2. **å‰ç«¯å¤„ç†**
   ```typescript
   // å½“æ”¶åˆ°æƒé™å˜æ›´é€šçŸ¥æ—¶
   function handleRoleChanged() {
     // æ¸…é™¤æœ¬åœ°token
     localStorage.removeItem('token');
     // è·³è½¬åˆ°ç™»å½•é¡µ
     router.push('/login');
     // æ˜¾ç¤ºæç¤º
     message.info('æ‚¨çš„æƒé™å·²æ›´æ–°ï¼Œè¯·é‡æ–°ç™»å½•');
   }
   ```

3. **åç«¯å¯é€‰å¢å¼º**
   - å®ç°tokené»‘åå•æœºåˆ¶
   - å½“è§’è‰²å˜æ›´æ—¶ï¼Œå°†æ—§tokenåŠ å…¥é»‘åå•
   - éªŒè¯tokenæ—¶åŒæ—¶æ£€æŸ¥é»‘åå•

### Tokenæœ‰æ•ˆæœŸè®¾ç½®

å½“å‰é…ç½®ï¼š
- Access Token: 1å°æ—¶
- Refresh Token: 30å¤©

å»ºè®®ï¼š
- æ•æ„Ÿæ“ä½œï¼ˆå¦‚ä¿®æ”¹ç³»ç»Ÿé…ç½®ï¼‰å¯ä»¥è¦æ±‚é‡æ–°éªŒè¯å¯†ç 
- æˆ–è€…ç¼©çŸ­Access Tokençš„æœ‰æ•ˆæœŸ

## ğŸ“Š æµ‹è¯•ç»“æœ

### ä½¿ç”¨æ–°tokenè®¿é—®ç®¡ç†å‘˜åŠŸèƒ½ âœ…

```
æµ‹è¯•ç®¡ç†å‘˜æƒé™è®¿é—®ç³»ç»Ÿè®¾ç½®ï¼š

âœ… æˆåŠŸè·å–ç³»ç»Ÿè®¾ç½®ï¼

ç³»ç»Ÿè®¾ç½®åˆ—è¡¨ï¼š
  login_announcement: æ¬¢è¿ä½¿ç”¨JDä»»åŠ¡å¹³å°ï¼
  system_name: JDä»»åŠ¡å¹³å°
  default_jingdou: 100
  min_jingdou_balance: 0
  task_create_time_start: 08:00
  task_create_time_end: 22:00
  max_tasks_per_day: 50
```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-12-15 03:35  
**é—®é¢˜æ ¹æº**: JWT tokenä¸­roleå­—æ®µä¸ºæ—§å€¼  
**è§£å†³æ–¹æ³•**: é‡æ–°ç™»å½•è·å–æ–°token  
**çŠ¶æ€**: âœ… å·²è§£å†³ï¼Œç®¡ç†å‘˜æƒé™æ­£å¸¸å·¥ä½œ
